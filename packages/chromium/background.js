"use strict";(()=>{var Ot=Object.create;var Me=Object.defineProperty;var Ct=Object.getOwnPropertyDescriptor;var kt=Object.getOwnPropertyNames;var jt=Object.getPrototypeOf,Mt=Object.prototype.hasOwnProperty;var V=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var It=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of kt(t))!Mt.call(e,a)&&a!==r&&Me(e,a,{get:()=>t[a],enumerable:!(o=Ct(t,a))||o.enumerable});return e};var Z=(e,t,r)=>(r=e!=null?Ot(jt(e)):{},It(t||!e||!e.__esModule?Me(r,"default",{value:e,enumerable:!0}):r,e));var Q=V((ye,Ie)=>{(function(e,t){if(typeof define=="function"&&define.amd)define("webextension-polyfill",["module"],t);else if(typeof ye<"u")t(Ie);else{var r={exports:{}};t(r),e.browser=r.exports}})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:ye,function(e){"use strict";if(!globalThis.chrome?.runtime?.id)throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){let t="The message port closed before a response was received.",r=o=>{let a={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(a).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class A extends WeakMap{constructor(i,x=void 0){super(x),this.createItem=i}get(i){return this.has(i)||this.set(i,this.createItem(i)),super.get(i)}}let f=s=>s&&typeof s=="object"&&typeof s.then=="function",n=(s,i)=>(...x)=>{o.runtime.lastError?s.reject(new Error(o.runtime.lastError.message)):i.singleCallbackArg||x.length<=1&&i.singleCallbackArg!==!1?s.resolve(x[0]):s.resolve(x)},p=s=>s==1?"argument":"arguments",m=(s,i)=>function(h,...P){if(P.length<i.minArgs)throw new Error(`Expected at least ${i.minArgs} ${p(i.minArgs)} for ${s}(), got ${P.length}`);if(P.length>i.maxArgs)throw new Error(`Expected at most ${i.maxArgs} ${p(i.maxArgs)} for ${s}(), got ${P.length}`);return new Promise((C,k)=>{if(i.fallbackToNoCallback)try{h[s](...P,n({resolve:C,reject:k},i))}catch{h[s](...P),i.fallbackToNoCallback=!1,i.noCallback=!0,C()}else i.noCallback?(h[s](...P),C()):h[s](...P,n({resolve:C,reject:k},i))})},g=(s,i,x)=>new Proxy(i,{apply(h,P,C){return x.call(P,s,...C)}}),l=Function.call.bind(Object.prototype.hasOwnProperty),d=(s,i={},x={})=>{let h=Object.create(null),P={has(k,c){return c in s||c in h},get(k,c,j){if(c in h)return h[c];if(!(c in s))return;let T=s[c];if(typeof T=="function")if(typeof i[c]=="function")T=g(s,s[c],i[c]);else if(l(x,c)){let F=m(c,x[c]);T=g(s,s[c],F)}else T=T.bind(s);else if(typeof T=="object"&&T!==null&&(l(i,c)||l(x,c)))T=d(T,i[c],x[c]);else if(l(x,"*"))T=d(T,i[c],x["*"]);else return Object.defineProperty(h,c,{configurable:!0,enumerable:!0,get(){return s[c]},set(F){s[c]=F}}),T;return h[c]=T,T},set(k,c,j,T){return c in h?h[c]=j:s[c]=j,!0},defineProperty(k,c,j){return Reflect.defineProperty(h,c,j)},deleteProperty(k,c){return Reflect.deleteProperty(h,c)}},C=Object.create(s);return new Proxy(C,P)},u=s=>({addListener(i,x,...h){i.addListener(s.get(x),...h)},hasListener(i,x){return i.hasListener(s.get(x))},removeListener(i,x){i.removeListener(s.get(x))}}),y=new A(s=>typeof s!="function"?s:function(x){let h=d(x,{},{getContent:{minArgs:0,maxArgs:0}});s(h)}),b=new A(s=>typeof s!="function"?s:function(x,h,P){let C=!1,k,c=new Promise(J=>{k=function(D){C=!0,J(D)}}),j;try{j=s(x,h,k)}catch(J){j=Promise.reject(J)}let T=j!==!0&&f(j);if(j!==!0&&!T&&!C)return!1;let F=J=>{J.then(D=>{P(D)},D=>{let Ae;D&&(D instanceof Error||typeof D.message=="string")?Ae=D.message:Ae="An unexpected error occurred",P({__mozWebExtensionPolyfillReject__:!0,message:Ae})}).catch(D=>{})};return F(T?j:c),!0}),M=({reject:s,resolve:i},x)=>{o.runtime.lastError?o.runtime.lastError.message===t?i():s(new Error(o.runtime.lastError.message)):x&&x.__mozWebExtensionPolyfillReject__?s(new Error(x.message)):i(x)},O=(s,i,x,...h)=>{if(h.length<i.minArgs)throw new Error(`Expected at least ${i.minArgs} ${p(i.minArgs)} for ${s}(), got ${h.length}`);if(h.length>i.maxArgs)throw new Error(`Expected at most ${i.maxArgs} ${p(i.maxArgs)} for ${s}(), got ${h.length}`);return new Promise((P,C)=>{let k=M.bind(null,{resolve:P,reject:C});h.push(k),x.sendMessage(...h)})},I={devtools:{network:{onRequestFinished:u(y)}},runtime:{onMessage:u(b),onMessageExternal:u(b),sendMessage:O.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:O.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},K={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return a.privacy={network:{"*":K},services:{"*":K},websites:{"*":K}},d(o,I,a)};e.exports=r(chrome)}else e.exports=globalThis.browser})});var ut=V((Cs,pt)=>{"use strict";pt.exports=()=>{let e={};return e.promise=new Promise((t,r)=>{e.resolve=t,e.reject=r}),e}});var gt=V((ks,ct)=>{"use strict";var Eo=ut();function Oo(e,t="maxAge"){let r,o,a,A=async()=>{if(r!==void 0)return;let p=async m=>{a=Eo();let g=m[1][t]-Date.now();if(g<=0){e.delete(m[0]),a.resolve();return}return r=m[0],o=setTimeout(()=>{e.delete(m[0]),a&&a.resolve()},g),typeof o.unref=="function"&&o.unref(),a.promise};try{for(let m of e)await p(m)}catch{}r=void 0},f=()=>{r=void 0,o!==void 0&&(clearTimeout(o),o=void 0),a!==void 0&&(a.reject(void 0),a=void 0)},n=e.set.bind(e);return e.set=(p,m)=>{e.has(p)&&e.delete(p);let g=n(p,m);return r&&r===p&&f(),A(),g},A(),e}ct.exports=Oo});var At=V((js,xt)=>{"use strict";var Co=gt(),Pe=class{constructor(t,r){if(this.maxAge=t,this[Symbol.toStringTag]="Map",this.data=new Map,Co(this.data),r)for(let[o,a]of r)this.set(o,a)}get size(){return this.data.size}clear(){this.data.clear()}delete(t){return this.data.delete(t)}has(t){return this.data.has(t)}get(t){let r=this.data.get(t);if(r)return r.data}set(t,r){return this.data.set(t,{maxAge:Date.now()+this.maxAge,data:r}),this}values(){return this.createIterator(t=>t[1].data)}keys(){return this.data.keys()}entries(){return this.createIterator(t=>[t[0],t[1].data])}forEach(t,r){for(let[o,a]of this.entries())t.apply(r,[a,o,this])}[Symbol.iterator](){return this.entries()}*createIterator(t){for(let r of this.data.entries())yield t(r)}};xt.exports=Pe});var w=Z(Q());var Nt=typeof global=="object"&&global&&global.Object===Object&&global,Y=Nt;var Rt=typeof self=="object"&&self&&self.Object===Object&&self,Bt=Y||Rt||Function("return this")(),E=Bt;var Dt=E.Symbol,W=Dt;var Ne=Object.prototype,Gt=Ne.hasOwnProperty,_t=Ne.toString,H=W?W.toStringTag:void 0;function Lt(e){var t=Gt.call(e,H),r=e[H];try{e[H]=void 0;var o=!0}catch{}var a=_t.call(e);return o&&(t?e[H]=r:delete e[H]),a}var Re=Lt;var Ut=Object.prototype,$t=Ut.toString;function Ft(e){return $t.call(e)}var Be=Ft;var Wt="[object Null]",qt="[object Undefined]",De=W?W.toStringTag:void 0;function Kt(e){return e==null?e===void 0?qt:Wt:De&&De in Object(e)?Re(e):Be(e)}var G=Kt;function Jt(e){return e!=null&&typeof e=="object"}var q=Jt;var Ht=Array.isArray,Ge=Ht;function zt(e){var t=typeof e;return e!=null&&(t=="object"||t=="function")}var X=zt;var Vt="[object AsyncFunction]",Zt="[object Function]",Qt="[object GeneratorFunction]",Yt="[object Proxy]";function Xt(e){if(!X(e))return!1;var t=G(e);return t==Zt||t==Qt||t==Vt||t==Yt}var ee=Xt;var er=E["__core-js_shared__"],te=er;var _e=function(){var e=/[^.]+$/.exec(te&&te.keys&&te.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}();function tr(e){return!!_e&&_e in e}var Le=tr;var rr=Function.prototype,or=rr.toString;function ar(e){if(e!=null){try{return or.call(e)}catch{}try{return e+""}catch{}}return""}var _=ar;var sr=/[\\^$.*+?()[\]{}|]/g,nr=/^\[object .+?Constructor\]$/,ir=Function.prototype,fr=Object.prototype,lr=ir.toString,mr=fr.hasOwnProperty,dr=RegExp("^"+lr.call(mr).replace(sr,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function pr(e){if(!X(e)||Le(e))return!1;var t=ee(e)?dr:nr;return t.test(_(e))}var Ue=pr;function ur(e,t){return e?.[t]}var $e=ur;function cr(e,t){var r=$e(e,t);return Ue(r)?r:void 0}var N=cr;var gr=N(E,"WeakMap"),re=gr;var xr=9007199254740991;function Ar(e){return typeof e=="number"&&e>-1&&e%1==0&&e<=xr}var oe=Ar;function yr(e){return e!=null&&oe(e.length)&&!ee(e)}var Fe=yr;var hr=Object.prototype;function br(e){var t=e&&e.constructor,r=typeof t=="function"&&t.prototype||hr;return e===r}var ae=br;var vr="[object Arguments]";function wr(e){return q(e)&&G(e)==vr}var he=wr;var We=Object.prototype,Tr=We.hasOwnProperty,Pr=We.propertyIsEnumerable,Sr=he(function(){return arguments}())?he:function(e){return q(e)&&Tr.call(e,"callee")&&!Pr.call(e,"callee")},qe=Sr;function Er(){return!1}var Ke=Er;var ze=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Je=ze&&typeof module=="object"&&module&&!module.nodeType&&module,Or=Je&&Je.exports===ze,He=Or?E.Buffer:void 0,Cr=He?He.isBuffer:void 0,kr=Cr||Ke,Ve=kr;var jr="[object Arguments]",Mr="[object Array]",Ir="[object Boolean]",Nr="[object Date]",Rr="[object Error]",Br="[object Function]",Dr="[object Map]",Gr="[object Number]",_r="[object Object]",Lr="[object RegExp]",Ur="[object Set]",$r="[object String]",Fr="[object WeakMap]",Wr="[object ArrayBuffer]",qr="[object DataView]",Kr="[object Float32Array]",Jr="[object Float64Array]",Hr="[object Int8Array]",zr="[object Int16Array]",Vr="[object Int32Array]",Zr="[object Uint8Array]",Qr="[object Uint8ClampedArray]",Yr="[object Uint16Array]",Xr="[object Uint32Array]",v={};v[Kr]=v[Jr]=v[Hr]=v[zr]=v[Vr]=v[Zr]=v[Qr]=v[Yr]=v[Xr]=!0;v[jr]=v[Mr]=v[Wr]=v[Ir]=v[qr]=v[Nr]=v[Rr]=v[Br]=v[Dr]=v[Gr]=v[_r]=v[Lr]=v[Ur]=v[$r]=v[Fr]=!1;function eo(e){return q(e)&&oe(e.length)&&!!v[G(e)]}var Ze=eo;function to(e){return function(t){return e(t)}}var Qe=to;var Ye=typeof exports=="object"&&exports&&!exports.nodeType&&exports,z=Ye&&typeof module=="object"&&module&&!module.nodeType&&module,ro=z&&z.exports===Ye,be=ro&&Y.process,oo=function(){try{var e=z&&z.require&&z.require("util").types;return e||be&&be.binding&&be.binding("util")}catch{}}(),ve=oo;var Xe=ve&&ve.isTypedArray,ao=Xe?Qe(Xe):Ze,et=ao;function so(e,t){return function(r){return e(t(r))}}var tt=so;var no=tt(Object.keys,Object),rt=no;var io=Object.prototype,fo=io.hasOwnProperty;function lo(e){if(!ae(e))return rt(e);var t=[];for(var r in Object(e))fo.call(e,r)&&r!="constructor"&&t.push(r);return t}var ot=lo;var mo=N(E,"Map"),se=mo;var po=N(E,"DataView"),ne=po;var uo=N(E,"Promise"),ie=uo;var co=N(E,"Set"),fe=co;var at="[object Map]",go="[object Object]",st="[object Promise]",nt="[object Set]",it="[object WeakMap]",ft="[object DataView]",xo=_(ne),Ao=_(se),yo=_(ie),ho=_(fe),bo=_(re),U=G;(ne&&U(new ne(new ArrayBuffer(1)))!=ft||se&&U(new se)!=at||ie&&U(ie.resolve())!=st||fe&&U(new fe)!=nt||re&&U(new re)!=it)&&(U=function(e){var t=G(e),r=t==go?e.constructor:void 0,o=r?_(r):"";if(o)switch(o){case xo:return ft;case Ao:return at;case yo:return st;case ho:return nt;case bo:return it}return t});var lt=U;var vo="[object Map]",wo="[object Set]",To=Object.prototype,Po=To.hasOwnProperty;function So(e){if(e==null)return!0;if(Fe(e)&&(Ge(e)||typeof e=="string"||typeof e.splice=="function"||Ve(e)||et(e)||qe(e)))return!e.length;var t=lt(e);if(t==vo||t==wo)return!e.size;if(ae(e))return!ot(e).length;for(var r in e)if(Po.call(e,r))return!1;return!0}var we=So;var Te=Z(Q());var $=(d=>(d.ChatGPT="chatgpt",d.GPT3="gpt3",d.Claude="claude",d.Gemini="gemini",d.Mistral="mistral",d.Anthropic="anthropic",d.Llama="llama",d.Baidu="baidu",d.AliModelScope="alimodelscope",d.Zhipu="zhipu",d.Qwen="qwen",d.Ollama="ollama",d))($||{});async function R(){let{provider:e="chatgpt"}=await Te.default.storage.local.get("provider"),t={["gpt3"]:void 0,["claude"]:void 0,["gemini"]:void 0,["mistral"]:void 0,["anthropic"]:void 0,["llama"]:void 0,["baidu"]:void 0,["alimodelscope"]:void 0,["zhipu"]:void 0,["qwen"]:void 0,["ollama"]:void 0},r=Object.values($),o=await Te.default.storage.local.get(r.map(a=>`provider:${a}`));for(let a of r){let A=`provider:${a}`,f=o[A]||{};if(f.apiKey&&f.apiKey.includes(",")){let n=f.apiKey.split(",").map(m=>m.trim()),p=n.length>0?Math.floor(Math.random()*n.length):0;f.apiKey=n[p]||""}t[a]=f}return{provider:e,configs:t}}var L="https://chat.openai.com";var mt="gpt-3.5-turbo",dt="api.openai.com";var wt=Z(At());var le,ko=new Uint8Array(16);function Se(){if(!le&&(le=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!le))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return le(ko)}var S=[];for(let e=0;e<256;++e)S.push((e+256).toString(16).slice(1));function yt(e,t=0){return S[e[t+0]]+S[e[t+1]]+S[e[t+2]]+S[e[t+3]]+"-"+S[e[t+4]]+S[e[t+5]]+"-"+S[e[t+6]]+S[e[t+7]]+"-"+S[e[t+8]]+S[e[t+9]]+"-"+S[e[t+10]]+S[e[t+11]]+S[e[t+12]]+S[e[t+13]]+S[e[t+14]]+S[e[t+15]]}var jo=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Ee={randomUUID:jo};function Mo(e,t,r){if(Ee.randomUUID&&!t&&!e)return Ee.randomUUID();e=e||{};let o=e.random||(e.rng||Se)();if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,t){r=r||0;for(let a=0;a<16;++a)t[r+a]=o[a];return t}return yt(o)}var me=Mo;function ht(e){let t,r,o,a,A,f,n;return p(),{feed:m,reset:p};function p(){t=!0,r="",o=0,a=-1,A=void 0,f=void 0,n=""}function m(l){r=r?r+l:l,t&&Io(r)&&(r=r.slice(bt.length)),t=!1;let d=r.length,u=0,y=!1;for(;u<d;){y&&(r[u]===`
`&&++u,y=!1);let b=-1,M=a,O;for(let I=o;b<0&&I<d;++I)O=r[I],O===":"&&M<0?M=I-u:O==="\r"?(y=!0,b=I-u):O===`
`&&(b=I-u);if(b<0){o=d-u,a=M;break}else o=0,a=-1;g(r,u,M,b),u+=b+1}u===d?r="":u>0&&(r=r.slice(u))}function g(l,d,u,y){if(y===0){n.length>0&&(e({type:"event",id:A,event:f||void 0,data:n.slice(0,-1)}),n="",A=void 0),f=void 0;return}let b=u<0,M=l.slice(d,d+(b?y:u)),O=0;b?O=y:l[d+u+1]===" "?O=u+2:O=u+1;let I=d+O,K=y-O,s=l.slice(I,I+K).toString();if(M==="data")n+=s?"".concat(s,`
`):`
`;else if(M==="event")f=s;else if(M==="id"&&!s.includes("\0"))A=s;else if(M==="retry"){let i=parseInt(s,10);Number.isNaN(i)||e({type:"reconnect-interval",value:i})}}}var bt=[239,187,191];function Io(e){return bt.every((t,r)=>e.charCodeAt(r)===t)}async function*vt(e){let t=e.getReader();try{for(;;){let{done:r,value:o}=await t.read();if(r)return;yield o}}finally{t.releaseLock()}}async function B(e,t){let{onMessage:r,...o}=t;try{let a=await fetch(e,o);if(!a.ok){let n;try{let m=await a.json();n=we(m)?`${a.status} ${a.statusText}`:JSON.stringify(m)}catch(m){try{n=await a.text()}catch(g){n=`${a.status} ${a.statusText}`}}let p={error:{message:`API\u8BF7\u6C42\u5931\u8D25: ${n}`,status:a.status}};throw r(JSON.stringify(p)),r("[DONE]"),new Error(`API\u8BF7\u6C42\u5931\u8D25: ${n}`)}if(!(a.headers.get("content-type")||"").includes("text/event-stream"))try{let n=await a.json();n.error,r(JSON.stringify(n)),r("[DONE]");return}catch(n){try{let p=await a.text(),m;try{m=JSON.parse(p)}catch(g){m={text:p}}r(JSON.stringify(m)),r("[DONE]");return}catch(p){r(JSON.stringify({error:"\u65E0\u6CD5\u8BFB\u53D6\u54CD\u5E94\u5185\u5BB9"})),r("[DONE]");return}}let f=ht(n=>{n.type==="event"&&r(n.data)});try{if(!a.body)throw new Error("\u54CD\u5E94\u6CA1\u6709body");for await(let n of vt(a.body)){let p=new TextDecoder().decode(n);f.feed(p)}}catch(n){r(JSON.stringify({error:n instanceof Error?n.message:"\u8BFB\u53D6\u54CD\u5E94\u6D41\u5931\u8D25"}))}r("[DONE]")}catch(a){throw r(JSON.stringify({error:{message:a instanceof Error?a.message:String(a),type:"fetch_error"}})),r("[DONE]"),a}}async function ke(e,t,r,o){return fetch(`${L}/backend-api${r}`,{method:t,headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:o===void 0?void 0:JSON.stringify(o)})}async function Tt(e,t){await ke(e,"POST","/conversation/message_feedback",t)}async function No(e,t,r){await ke(e,"PATCH",`/conversation/${t}`,r)}var Oe="accessToken",Ce=new wt.default(10*1e3);async function pe(){if(Ce.get(Oe))return Ce.get(Oe);let e=await fetch(`${L}/api/auth/session`);if(e.status===403)throw new Error("CLOUDFLARE");let t=await e.json().catch(()=>({}));if(!t.accessToken)throw new Error("UNAUTHORIZED");return Ce.set(Oe,t.accessToken),t.accessToken}var de=class{constructor(t){this.token=t;this.token=t}async fetchModels(){return(await ke(this.token,"GET","/models").then(r=>r.json())).models}async getModelName(){try{return(await this.fetchModels())[0].slug}catch(t){return"text-davinci-002-render-sha"}}async generateAnswer(t){let r,o=()=>{r&&No(this.token,r,{is_visible:!0})},a=await this.getModelName();return await B(`${L}/backend-api/conversation`,{method:"POST",signal:t.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({action:"next",messages:[{id:me(),role:"user",content:{content_type:"text",parts:[t.prompt]}}],model:a,parent_message_id:me()}),onMessage(A){var p,m,g;if(A==="[DONE]"){t.onEvent({type:"done"}),o();return}let f;try{f=JSON.parse(A)}catch(l){return}let n=(g=(m=(p=f.message)==null?void 0:p.content)==null?void 0:m.parts)==null?void 0:g[0];n&&(r=f.conversation_id,t.onEvent({type:"answer",data:{text:n,messageId:f.message.id,conversationId:f.conversation_id}}))}}),{cleanup:o}}};var ue=class{constructor(t,r){this.token=t;this.model=r;this.token=t,this.model=r}buildPrompt(t){return this.model.startsWith("text-chat-davinci")?`Respond conversationally.<|im_end|>

User: ${t}<|im_sep|>
ChatGPT:`:t}buildMessages(t){return[{role:"user",content:t}]}async generateAnswer(t){var m,g,l,d;let[r]=await Promise.all([R()]),o=(g=(m=r.configs["gpt3"])==null?void 0:m.model)!=null?g:mt,a=((l=r.configs["gpt3"])==null?void 0:l.apiHost)||dt,A=(d=r.configs["gpt3"])==null?void 0:d.apiPath,f="",n={model:this.model,stream:!0,max_tokens:800};o==="text-davinci-003"?(f=`https://${a}${A||"/v1/completions"}`,n={...n,prompt:this.buildPrompt(t.prompt)}):(f=`https://${a}${A||"/v1/chat/completions"}`,n={...n,messages:this.buildMessages(t.prompt)});let p="";return await B(f,{method:"POST",signal:t.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify(n),onMessage(u){if(u==="[DONE]"){t.onEvent({type:"done"});return}let y;try{y=JSON.parse(u);let b=o==="text-davinci-003"?y.choices[0].text:y.choices[0].delta.content;if(b===void 0||b==="<|im_end|>"||b==="<|im_sep|>")return;p+=b,t.onEvent({type:"answer",data:{text:p,messageId:y.id,conversationId:y.id}})}catch(b){return}}}),{}}};var ce=class{constructor(t,r){this.token=t;this.model=r;this.token=t,this.model=r}buildMessages(t){return[{role:"user",content:t}]}async generateAnswer(t){let[r]=await Promise.all([R()]),o=r.configs["claude"],a=(o==null?void 0:o.model)||"claude-3-opus-20240229",A=(o==null?void 0:o.apiHost)||"api.anthropic.com",f=(o==null?void 0:o.apiPath)||"/v1/messages",n=`https://${A}${f}`,p={model:a,messages:this.buildMessages(t.prompt),max_tokens:4e3,stream:!0},m="";return await B(n,{method:"POST",signal:t.signal,headers:{"Content-Type":"application/json","x-api-key":this.token,"anthropic-version":"2023-06-01"},body:JSON.stringify(p),onMessage(g){var d;if(g==="[DONE]"){t.onEvent({type:"done"});return}let l;try{l=JSON.parse(g);let u=((d=l.delta)==null?void 0:d.text)||"";if(u===void 0)return;m+=u,t.onEvent({type:"answer",data:{text:m,messageId:l.id,conversationId:l.id}})}catch(u){return}}}),{}}};var ge=class{constructor(t,r){this.token=t;this.model=r;this.token=t,this.model=r}buildContents(t){return{contents:[{parts:[{text:t}]}],generationConfig:{maxOutputTokens:4096,temperature:.7,stopSequences:[]},safetySettings:[]}}async generateAnswer(t){try{let[r]=await Promise.all([R()]),o=r.configs["gemini"],a=this.model||(o==null?void 0:o.model)||"gemini-2.0-flash",A=(o==null?void 0:o.apiHost)||"generativelanguage.googleapis.com",f=(o==null?void 0:o.apiPath)||"";f||(f=`/v1beta/models/${a}:generateContent`);let n=`https://${A}${f}?key=${this.token}`,p=this.buildContents(t.prompt),m="";return await B(n,{method:"POST",signal:t.signal,headers:{"Content-Type":"application/json"},body:JSON.stringify(p),onMessage(g){var d,u;if(g==="[DONE]"){t.onEvent({type:"done"});return}let l;try{if(l=JSON.parse(g),l.error){t.onEvent({type:"answer",data:{text:`Error from Gemini API: ${l.error.message||JSON.stringify(l.error)}`,messageId:"error",conversationId:"error"}});return}let y="";l.candidates&&l.candidates[0]?l.candidates[0].content&&l.candidates[0].content.parts&&l.candidates[0].content.parts.length>0?y=l.candidates[0].content.parts[0].text||"":l.candidates[0].content&&l.candidates[0].content.parts?y=l.candidates[0].content.parts.map(b=>b.text||"").join("")||"":l.candidates[0].text&&(y=l.candidates[0].text):l.text?y=l.text:l.content&&l.content.parts&&(y=l.content.parts.map(b=>b.text||"").join("")||""),y&&(m+=y,t.onEvent({type:"answer",data:{text:m,messageId:((u=(d=l.candidates)==null?void 0:d[0])==null?void 0:u.finishReason)||Date.now().toString(),conversationId:Date.now().toString()}}))}catch(y){try{g&&typeof g=="string"&&g!=="[DONE]"&&(g.includes("error")||g.includes("Error")?t.onEvent({type:"answer",data:{text:`Error: ${g}`,messageId:Date.now().toString(),conversationId:Date.now().toString()}}):(m+=g,t.onEvent({type:"answer",data:{text:m,messageId:Date.now().toString(),conversationId:Date.now().toString()}})))}catch(b){}}}}),{}}catch(r){throw r}}};var xe=class{constructor(t,r){this.token=t;this.model=r;this.token=t,this.model=r}buildMessages(t){return[{role:"user",content:t}]}async generateAnswer(t){let[r]=await Promise.all([R()]),o=r.configs["mistral"],a=(o==null?void 0:o.model)||"mistral-large-latest",A=(o==null?void 0:o.apiHost)||"api.mistral.ai",f=(o==null?void 0:o.apiPath)||"/v1/chat/completions",n=`https://${A}${f}`,p={model:a,messages:this.buildMessages(t.prompt),max_tokens:4096,stream:!0},m="";return await B(n,{method:"POST",signal:t.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify(p),onMessage(g){var d,u,y;if(g==="[DONE]"){t.onEvent({type:"done"});return}let l;try{l=JSON.parse(g);let b=((y=(u=(d=l.choices)==null?void 0:d[0])==null?void 0:u.delta)==null?void 0:y.content)||"";if(b===void 0)return;m+=b,t.onEvent({type:"answer",data:{text:m,messageId:l.id,conversationId:l.id}})}catch(b){return}}}),{}}};var je=Z(Q());var dn=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),Pt=navigator.userAgent.indexOf("Firefox")!=-1,pn=/iPad|iPhone|iPod/.test(navigator.userAgent);function St(e){let{id:t,url:r}=e;r.includes(`${L}/chat`)?je.default.tabs.sendMessage(t,{type:"CHATGPT_TAB_CURRENT",data:{isLogin:!0}}).catch(()=>{}):je.default.tabs.sendMessage(t,{type:"CHATGPT_TAB_CURRENT",data:{isLogin:!1}}).catch(()=>{})}async function Ro(e,t){let r=await R(),o;if(r.provider==="chatgpt"){let f=await pe();o=new de(f)}else if(r.provider==="gpt3"){let{apiKey:f,model:n}=r.configs["gpt3"];o=new ue(f,n)}else if(r.provider==="claude"){let{apiKey:f,model:n}=r.configs["claude"];o=new ce(f,n)}else if(r.provider==="gemini"){let{apiKey:f,model:n}=r.configs["gemini"];o=new ge(f,n)}else if(r.provider==="mistral"){let{apiKey:f,model:n}=r.configs["mistral"];o=new xe(f,n)}else throw new Error(`Unknown provider ${r.provider}`);let a=new AbortController;e.onDisconnect.addListener(()=>{a.abort(),A==null||A()});let{cleanup:A}=await o.generateAnswer({prompt:t,signal:a.signal,onEvent(f){if(f.type==="done"){e.postMessage({event:"DONE"});return}e.postMessage(f.data)}})}async function Bo(e){w.default.tabs.query({currentWindow:!0,active:!0}).then(o=>{let a=o[0];a.id&&w.default.storage.local.set({glarityTabId:a.id})});let t=await w.default.storage.local.get("pinnedTabId"),r;if(t.pinnedTabId)try{r=await w.default.tabs.get(t.pinnedTabId),w.default.tabs.update(r.id,{active:!0,pinned:!0})}catch(o){}return r||(r=await w.default.tabs.create({url:e,pinned:!0,active:!0})),w.default.storage.local.set({pinnedTabId:r.id}),{pinnedTabId:r.id}}w.default.runtime.onConnect.addListener(async e=>{e.onMessage.addListener(async t=>{try{await Ro(e,t.question)}catch(r){e.postMessage({error:r.message})}})});w.default.runtime.onMessage.addListener(async e=>{if(e.type==="FEEDBACK"){let t=await pe();await Tt(t,e.data)}else if(e.type==="OPEN_OPTIONS_PAGE")w.default.runtime.openOptionsPage();else{if(e.type==="GET_ACCESS_TOKEN")return pe();if(e.type==="NEW_TAB")return Bo(e.data.url);if(e.type==="GO_BACK"){let t=await w.default.storage.local.get("glarityTabId");t.glarityTabId?w.default.tabs.update(t.glarityTabId,{active:!0}).catch(()=>{w.default.tabs.create({url:"about:newtab",active:!0})}):w.default.tabs.create({url:"about:newtab",active:!0})}}});w.default.runtime.onInstalled.addListener(async e=>{e.reason==="install"&&w.default.runtime.openOptionsPage()});w.default.tabs.onUpdated.addListener(async(e,t)=>{let r=await w.default.storage.local.get("pinnedTabId");w.default.tabs.get(e).then(o=>{var a;(a=o.url)!=null&&a.includes(L)&&t.status==="complete"&&o.id&&r.pinnedTabId===o.id&&St(o)})});async function Et(e){let{id:t}=e;t&&w.default.tabs.sendMessage(t,{type:"OPEN_WEB_SUMMARY",data:{}}).catch(()=>{})}Pt?w.default.browserAction.onClicked.addListener(async e=>{await Et(e)}):w.default.action.onClicked.addListener(async e=>{await Et(e)});})();
